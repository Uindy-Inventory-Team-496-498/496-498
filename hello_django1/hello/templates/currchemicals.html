{% extends "layout.html" %}

{% block title %}
    Current Chemicals
{% endblock %}

{% block content %}
    <h2>Logged Chemicals</h2>

    <form action="{% url 'add_chemical' 'currentlyinstoragetable' %}" method="get">
        <button type="submit" class="button-style">Add New Chemical</button>
    </form>

    {% if chemical_list_db %}
    <label for="sort-actions">Sort list by:</label>
    <select name="sort-actions" id="sort-actions" onchange="sortList('chemical-table-body')">
        <option value="a-z">A-Z</option>
        <option value="z-a">Z-A</option>
        <option value="amount-asc">Amount (Low to High)</option>
        <option value="amount-desc">Amount (High to Low)</option>
        <option value="id-asc">ID# (Low to High)</option>
        <option value="id-desc">ID# (High to Low)</option>
    </select><br>

    <p style="display: inline;"><strong>Chemical Type:</strong></p>
    <input type="radio" id="any-type" name="type-choice" value="any" checked onchange="filterList('chemical-table-body')">
    <label for="any-type">Any</label>
    {% for chem_type in chemical_types %}
        <input type="radio" id="{{ chem_type|lower }}" name="type-choice" value="{{ chem_type|lower }}" onchange="filterList('chemical-table-body')">
        <label for="{{ chem_type|lower }}">{{ chem_type }}</label>
    {% endfor %}
    <br>

    <p style="display: inline;"><strong>Location:</strong></p>
    <input type="radio" id="any-location" name="location" value="any" checked onchange="filterList('chemical-table-body')">
    <label for="any-location">Any</label>
    {% for location in chemical_locations %}
        <input type="radio" id="{{ location|lower }}" name="location" value="{{ location|lower }}" onchange="filterList('chemical-table-body')">
        <label for="{{ location|lower }}">{{ location }}</label>
    {% endfor %}
    <br>

    <p style="display: inline;"><strong>SDS:</strong></p>
    <input type="radio" id="any-sds" name="sds-choice" value="any" checked onchange="filterList('chemical-table-body')">
    <label for="any-sds">Any</label>
    <input type="radio" id="sds-1" name="sds-choice" value="1" onchange="filterList('chemical-table-body')">
    <label for="sds-1">1</label>
    <input type="radio" id="sds-0" name="sds-choice" value="0" onchange="filterList('chemical-table-body')">
    <label for="sds-0">0</label>
    <input type="radio" id="sds-none" name="sds-choice" value="none" onchange="filterList('chemical-table-body')">
    <label for="sds-none">None</label><br>

    <table class="chemical_list_db">
        <thead>
            <tr>
                <th>ID</th>
                <th>Material</th>
                <th>Name</th>
                <th>Room</th>
                <th>Cabinet</th>
                <th>Shelf</th>
                <th>Amount</th>
                <th>Unit</th>
                <th>Concentration</th>
                <th>SDS</th>
                <th>Notes</th>
                <th>Instrument</th>
                <th>Edit</th>
                <th>Delete</th> 
            </tr>
        </thead>
        <tbody id="chemical-table-body">
            {% for chemical in chemical_list_db %}
            <tr class="chemical-row" data-type="{{ chemical.chemMaterial|lower }}" data-location="{{ chemical.chemLocationRoom|default_if_none:'none'|lower }}" data-sds="{{ chemical.chemSDS }}">
                <td>{{ chemical.chemBottleIDNUM }}</td>
                <td>{{ chemical.chemMaterial }}</td>
                <td>{{ chemical.chemName }}</td>
                <td>{{ chemical.chemLocationRoom|default_if_none:'None' }}</td>
                <td>{{ chemical.chemLocationCabinet }}</td>
                <td>{{ chemical.chemLocationShelf }}</td>
                <td>{{ chemical.chemAmountInBottle }}</td>
                <td>{{ chemical.chemAmountUnit }}</td>
                <td>{{ chemical.chemConcentration }}</td>
                <td>{{ chemical.chemSDS }}</td>
                <td>{{ chemical.chemNotes }}</td>
                <td>{{ chemical.chemInstrument }}</td>
                <td>
                    <!-- Edit Chemical Button -->
                    <form action="{% url 'edit_chemical' 'currentlyinstoragetable' chemical.chemBottleIDNUM %}" method="get" style="display:inline;">
                        <button type="submit" class="button-style">Edit</button>
                    </form>
                </td>
                <td>
                    <!-- Delete Chemical Button -->
                    <form method="POST" action="{% url 'delete_chemical' 'currentlyinstoragetable' chemical.chemBottleIDNUM %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" onclick="return confirm('Are you sure you want to delete this chemical?')" class="button-style">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No chemicals have been logged.</p>
    {% endif %}

    <script>
        function sortList(tableBodyId) {
            const sortOption = document.getElementById(tableBodyId === 'chemical-table-body' ? 'sort-actions' : 'sort-actions-all').value;
            const tableBody = document.getElementById(tableBodyId);
            const rows = Array.from(tableBody.rows);

            rows.sort((a, b) => {
                const aValue = getSortValue(a, sortOption);
                const bValue = getSortValue(b, sortOption);

                switch (sortOption) {
                    case 'a-z':
                        return aValue.localeCompare(bValue);
                    case 'z-a':
                        return bValue.localeCompare(aValue);
                    case 'amount-asc':
                        return parseFloat(a.cells[6].textContent) - parseFloat(b.cells[6].textContent); // Sort by amount ascending
                    case 'amount-desc':
                        return parseFloat(b.cells[6].textContent) - parseFloat(a.cells[6].textContent); // Sort by amount descending
                    case 'id-asc':
                        return parseInt(a.cells[0].textContent) - parseInt(b.cells[0].textContent); // Sort by ID ascending
                    case 'id-desc':
                        return parseInt(b.cells[0].textContent) - parseInt(a.cells[0].textContent); // Sort by ID descending
                    default:
                        return 0;
                }
            });

            tableBody.innerHTML = '';

            rows.forEach(row => tableBody.appendChild(row));
        }

        function getSortValue(row, sortOption) {
            switch (sortOption) {
                case 'a-z':
                case 'z-a':
                    return row.cells[2].textContent; // Sort by name
                case 'amount-asc':
                case 'amount-desc':
                    return row.cells[6].textContent; // Sort by amount
                case 'id-asc':
                case 'id-desc':
                    return row.cells[0].textContent; // Sort by ID
                default:
                    return ''; 
            }
        }

        function filterList(tableBodyId) {
            const selectedType = document.querySelector(`input[name="type-choice${tableBodyId === 'chemical-table-body' ? '' : '-all'}"]:checked`).value;
            const selectedLocation = document.querySelector(`input[name="location${tableBodyId === 'chemical-table-body' ? '' : '-all'}"]:checked`).value;
            const selectedSDS = document.querySelector(`input[name="sds-choice${tableBodyId === 'chemical-table-body' ? '' : '-all'}"]:checked`).value;
            const rows = document.querySelectorAll(`#${tableBodyId} .chemical-row`);

            rows.forEach(row => {
                const rowType = row.getAttribute('data-type');
                const rowLocation = row.getAttribute('data-location');
                const rowSDS = row.getAttribute('data-sds');
    
                // Check if the row matches the selected type
                const typeMatches = (selectedType === 'any' || rowType === selectedType);

                // Check if the row matches the selected location
                const locationMatches = (selectedLocation === 'any' || rowLocation === selectedLocation || (selectedLocation === 'none' && !rowLocation));

                // Check if the row matches the selected SDS
                const sdsMatches = (selectedSDS === 'any' || rowSDS === selectedSDS || (selectedSDS === 'none' && !rowSDS));

                // Show or hide the row based on type, location, and SDS matching
                if (typeMatches && locationMatches && sdsMatches) {
                    row.style.display = ''; // Show row
                } else {
                    row.style.display = 'none'; // Hide row
                }
            });
        }
    </script>
{% endblock %}